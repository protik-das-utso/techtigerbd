<!doctype html>
<html lang="bn">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Delivery — Tech Tiger BD</title>
  <link rel="icon" type="image/svg+xml" href="../assets/og.jpg">
  <meta name="robots" content="noindex,follow" />
  <meta name="theme-color" content="#ffffff" />

  <!-- Header -->
  <link rel="stylesheet" href="../components/header/header-component.css">
  <script defer src="../components/header/header-component.js"></script>

  <style>
    :root {
      --bg: #f6f8fb;
      --card: #ffffff;
      --card-2: #f3f7fb;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e6eaf3;
      --shadow: 0 14px 30px rgba(2, 6, 23, .07);
      --accent: #10a37f;
      --accent-ink: #ffffff;
      /* green */
      --ok: #16a34a;
      --bad: #ef4444;
      --pending: #6366f1;
      --radius: 18px;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", "Helvetica Neue", Arial
    }

    a {
      color: #2563eb;
      text-decoration: none
    }

    a:hover {
      text-decoration: underline
    }

    /* Topbar */
    .topbar {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: saturate(180%) blur(6px);
      background: rgba(255, 255, 255, .8);
      border-bottom: 1px solid var(--border)
    }

    .topbar .inner {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: .6rem;
      color: var(--text);
      font-weight: 900
    }

    .brand-logo {
      display: grid;
      place-items: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      background: var(--accent);
      color: #fff;
      font-weight: 900
    }

    /* Layout */
    .wrap {
      max-width: 960px;
      margin: 22px auto;
      padding: 18px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow)
    }

    .h2 {
      font-size: 26px;
      line-height: 1.2;
      margin: .2rem 0 0
    }

    .headline {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      font-size: 12px;
      font-weight: 800;
      color: #475569;
      padding: .25rem .55rem;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid #dfe5ff
    }

    .badge--accent {
      background: #eafbf5;
      border: 1px solid #bfeedd;
      color: #065f46
    }

    /* Summary row */
    .row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--card-2);
      border: 1px solid var(--border);
      padding: .45rem .7rem;
      border-radius: 999px;
      font-weight: 700
    }

    .pill .sep {
      opacity: .6
    }

    .kv {
      display: flex;
      gap: 16px;
      flex-wrap: wrap
    }

    .kv b {
      margin-right: 6px
    }

    /* Status box */
    .status-box {
      margin-top: 12px;
      padding: 14px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #f8fafc;
      display: flex;
      align-items: center;
      gap: 10px
    }

    .spinner {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid #dbeafe;
      border-top-color: #2563eb;
      animation: sp 1s linear infinite
    }

    @keyframes sp {
      to {
        transform: rotate(360deg)
      }
    }

    .status-chip {
      font: 700 12px/1 ui-sans-serif;
      letter-spacing: .2px;
      padding: .28rem .5rem;
      border-radius: 999px;
      border: 1px solid
    }

    .status-chip.pending {
      color: #3730a3;
      border-color: #c7d2fe;
      background: #eef2ff
    }

    .status-chip.ok {
      color: #065f46;
      border-color: #bbf7d0;
      background: #e9fbf6
    }

    .status-chip.bad {
      color: #7f1d1d;
      border-color: #fecaca;
      background: #fff1f2
    }

    /* Credentials */
    .cred {
      margin-top: 12px;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #ffffff
    }

    .cred .row {
      align-items: flex-end
    }

    .label {
      font-size: 12px;
      color: var(--muted)
    }

    .value {
      font-weight: 800;
      word-break: break-all
    }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      border-radius: 12px;
      padding: .72rem 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: transform .08s, box-shadow .15s
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(2, 6, 23, .08)
    }

    .btn-primary {
      background: #111827;
      color: #fff;
      border-color: #111827
    }

    .btn--accent {
      background: linear-gradient(135deg, #21b18c, #10a37f);
      color: #fff;
      border-color: #10a37f
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px
    }

    .guide {
      margin-top: 10px;
      padding: 10px 12px;
      background: #fff7ef;
      border: 1px dashed #f5a463;
      border-radius: 12px;
      color: #7a3b00;
      font-size: 14px
    }

    .muted {
      color: var(--muted)
    }

    @media (max-width:560px) {
      .h2 {
        font-size: 22px
      }

      .btn {
        padding: .65rem .9rem
      }
    }
  </style>
</head>

<body>

  <main class="wrap card" role="main" data-page="delivery">
    <div class="headline">
      <div class="badge badge--accent">Delivery</div>
      <h2 id="pageTitle" class="h2">—</h2>
    </div>

    <!-- Summary -->
    <div class="row" style="margin:.5rem 0 .6rem">
      <div class="pill">
        <span id="accType">Account: —</span>
        <span class="sep">•</span>
        <span id="statusChip" class="status-chip pending">Pending</span>
      </div>
      <div class="kv">
        <div><b>Total:</b> <span id="sumTotal">৳0</span></div>
        <div><b>Qty:</b> <span id="sumQty">1</span></div>
      </div>
    </div>

    <!-- Pending / result -->
    <div id="statusBox" class="status-box">
      <div id="statusSpinner" class="spinner" aria-hidden="true"></div>
      <div>
        <div id="statusHeadline" style="font-weight:800;margin-bottom:2px">Processing…</div>
        <div class="muted" id="statusText">Contacting server to deliver your order.</div>
      </div>
    </div>

    <!-- Credentials (hidden until success) -->
    <div id="credBox" class="cred" hidden>
      <div style="font-weight:800;margin-bottom:6px">✅ Delivered</div>

      <div class="row">
        <div style="flex:1">
          <div class="label">Email / Username</div>
          <div id="cMail" class="value">—</div>
        </div>
        <button class="btn" id="copyMail">Copy</button>
      </div>

      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <div class="label">Password</div>
          <div id="cPass" class="value">—</div>
        </div>
        <button class="btn" id="copyPass">Copy</button>
      </div>

      <div id="profileRow" class="row" style="margin-top:8px" hidden>
        <div style="flex:1">
          <div class="label">Profile</div>
          <div id="cProfile" class="value">—</div>
        </div>
        <button class="btn" id="copyProfile">Copy</button>
      </div>

      <div class="actions">
        <button class="btn" id="copyAll">Copy All</button>
        <button class="btn" id="btnWhatsAppOk">Contact WhatsApp</button>
        <a class="btn btn--accent" href="/">Back Home</a>
      </div>

      <div id="guideBox" class="guide" style="display:none"></div>
    </div>

    <!-- Manual verified (no auto cred) -->
    <div id="manualBox" class="cred" hidden>
      <div style="font-weight:800;margin-bottom:6px">✅ Payment verified</div>
      <div class="muted">Click below to request your account on WhatsApp.</div>
      <div class="actions"><button class="btn btn-primary" id="btnWhatsAppManual">Get Account on WhatsApp</button></div>
    </div>

    <!-- Error -->
    <div id="errorBox" class="cred" hidden>
      <div style="font-weight:800;color:#ff4d6d;margin-bottom:6px">❌ Delivery failed</div>
      <div id="errMsg" class="muted">Unknown error</div>
      <div class="actions">
        <button class="btn" id="btnWhatsAppBad">Contact WhatsApp</button>
        <button class="btn" onclick="location.reload()">Try Again</button>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      HeaderComponent.create(HeaderComponent.configs.PAGETYPE);
    });
  </script>

  <script>
    (function () {
      // ===== Config (same as your pay/app) =====
      const GAS_URL = "https://script.google.com/macros/s/AKfycbyLjru6Gqm9qlXUWgDYPCMaGGeEIam0OrWRguPVTGYj73eI6zyt745aZaWRLreVJmGt/exec";
      const WHATSAPP_URL = "https://wa.me/8801883044415";

      // ===== Helpers =====
      const $ = (q, r = document) => r.querySelector(q);
      const fmtTk = v => "৳" + Number(v || 0);
      const copy = async (text) => {
        try {
          if (navigator.clipboard && window.isSecureContext) { await navigator.clipboard.writeText(text); return alert('Copied!'); }
          const ta = document.createElement('textarea'); ta.value = text; ta.style.position = 'fixed'; ta.style.opacity = '0';
          document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); alert('Copied!');
        } catch (e) { alert('Copy failed.'); }
      };
      const chip = (cls, text) => { const el = $('#statusChip'); el.className = 'status-chip ' + cls; el.textContent = text; };

      function detectAccountType(mode, service, plan, product) {
        if (mode === 'auto-cr') {
          if (/shared/i.test(service || plan || product)) return 'Shared';
          return 'Personal';
        }
        if (mode === 'freefire') return 'Top-up';
        return 'Manual';
      }

      function openWhatsApp(trx, label, statusText) {
        const lines = [
          `I ordered "${label}"`,
          `Status: ${statusText || 'Pending'}`,
          trx ? `Trxid: ${trx}` : ''
        ].filter(Boolean);
        const text = lines.join('\n');
        const url = `${WHATSAPP_URL}?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
      }

      // Show "done" in the status area and hide spinner
      function markDone(successLabel) {
        $('#statusSpinner').style.display = 'none';
        $('#statusHeadline').textContent = 'Processing done';
        $('#statusText').innerHTML = `Status: <b>${successLabel}</b>.`;
      }

      // ===== Parse query =====
      const qs = new URLSearchParams(location.search);
      const p = {
        trxid: (qs.get('trxid') || '').trim(),
        product: qs.get('product') || 'Product',
        plan: qs.get('plan') || '',
        price: Number(qs.get('price') || 0),
        qty: Number(qs.get('qty') || 1),
        mode: qs.get('mode') || 'manual',        // auto-cr | manual | freefire
        service: qs.get('service') || '',        // auto-cr
        productKey: qs.get('productkey') || qs.get('productKey') || '', // manual
        uid: qs.get('uid') || '',                // freefire
        uc: qs.get('uc') || '',                  // freefire
        email: qs.get('contact_email') || '',
        phone: qs.get('phone') || ''
      };

      const label = p.product + (p.plan ? (' • ' + p.plan) : '');
      $('#pageTitle').textContent = label;
      $('#sumQty').textContent = String(p.qty || 1);
      $('#sumTotal').textContent = fmtTk((p.price || 0) * (p.qty || 1));
      $('#accType').textContent = 'Account: ' + detectAccountType(p.mode, p.service, p.plan, p.product);

      // ===== Elements =====
      const statusBox = $('#statusBox'), statusText = $('#statusText');
      const credBox = $('#credBox'), manualBox = $('#manualBox'), errorBox = $('#errorBox');

      async function run() {
        // Guard
        if (!p.trxid) {
          chip('bad', 'Failed');
          markDone('Failed');
          statusText.textContent = 'Please go back to the payment page and enter your TrxID.';
          $('#btnWhatsAppBad')?.addEventListener('click', () => openWhatsApp('', label, 'Pending'));
          errorBox.hidden = false; /* keep statusBox visible */ return;
        }

        try {
          // Build URL by mode
          let url = '';
          const contact = `&contact_email=${encodeURIComponent(p.email || '')}&phone=${encodeURIComponent(p.phone || '')}&t=${Date.now()}`;
          if (p.mode === 'auto-cr') {
            url = `${GAS_URL}?trxid=${encodeURIComponent(p.trxid)}&service=${encodeURIComponent(p.service)}${contact}`;
          } else if (p.mode === 'freefire') {
            url = `${GAS_URL}?action=freefire_topup&trxid=${encodeURIComponent(p.trxid)}&uid=${encodeURIComponent(p.uid || '')}&uc=${encodeURIComponent(p.uc || '')}${contact}`;
          } else {
            url = `${GAS_URL}?action=verify_only&trxid=${encodeURIComponent(p.trxid)}&product=${encodeURIComponent(p.productKey || '')}${contact}`;
          }

          // Show pending
          chip('pending', 'Pending');
          statusText.textContent = 'Processing your order…';

          const res = await fetch(url);
          let data = null;
          try { data = await res.json(); } catch (e) { }

          // ===== AUTO DELIVERY =====
          if (p.mode === 'auto-cr') {
            const ok = !!(data && data.success && data.account && (data.account.mail || data.account.pass));
            if (ok) {
              chip('ok', 'Success');
              markDone('Success');

              // fill creds
              $('#cMail').textContent = data.account.mail || '';
              $('#cPass').textContent = data.account.pass || '';
              const prof = data.account.profile || '';
              if (prof) { $('#cProfile').textContent = prof; $('#profileRow').hidden = false; }

              // Copy buttons
              $('#copyMail').addEventListener('click', () => copy($('#cMail').textContent.trim()));
              $('#copyPass').addEventListener('click', () => copy($('#cPass').textContent.trim()));
              $('#copyProfile')?.addEventListener('click', () => copy($('#cProfile').textContent.trim()));
              $('#copyAll').addEventListener('click', () => {
                const m = $('#cMail').textContent.trim(), pw = $('#cPass').textContent.trim(), pr = $('#cProfile')?.textContent.trim();
                copy(`Email/Username: ${m}\nPassword: ${pw}${pr ? `\nProfile: ${pr}` : ''}`);
              });
              $('#btnWhatsAppOk').addEventListener('click', () => openWhatsApp(p.trxid, label, 'Paid'));

              // Shared vs Personal guide
              const isShared = /shared/i.test((p.service || '') + ' ' + (data.account.service || '') + ' ' + (p.plan || ''));
              const guide = isShared
                ? `<strong>Shared Account নির্দেশনা</strong>
                 <ul style="margin:.25rem 0 0;padding-left:1.15rem;">
                   <li>যেকোনো প্রোফাইল ব্যবহার করুন</li>
                   <li>সর্বোচ্চ ১ ডিভাইস লগইন।</li>
                   <li>কোনো তথ্য/ইমেইল/পাস পরিবর্তন করবেন না।</li>
                   <li>প্রোফাইল নাম/পিন পরিবর্তন করবেন না।</li>
                   <li>লগআউট হলে একই মেইল/পাস দিয়ে আবার লগইন করবেন।</li>
                   <li>WhatsApp: 01881738485</li>
                 </ul>`
                : `<strong>Personal Profile নির্দেশনা</strong>
                 <ul style="margin:.25rem 0 0;padding-left:1.15rem;">
                   <li>সর্বোচ্চ ২ ডিভাইসে লগইন দিন।</li>
                   <li>আপনার নামে প্রোফাইল থাকলে সেটিই ব্যবহার করুন।</li>
                   <li>রিনিউ করতে চাইলে মেয়াদ শেষের ২ দিন আগে জানাবেন।</li>
                   <li>WhatsApp: 01881738485</li>
                 </ul>`;
              $('#guideBox').innerHTML = guide;
              $('#guideBox').style.display = 'block';

              credBox.hidden = false; /* keep statusBox visible */ return;
            } else {
              chip('bad', 'Failed');
              markDone('Failed');
              $('#errMsg').textContent = (data && data.message) || 'Invalid TrxID or service unavailable.';
              $('#btnWhatsAppBad').addEventListener('click', () => openWhatsApp(p.trxid, label, 'Failed'));
              errorBox.hidden = false; /* keep statusBox visible */ return;
            }
          }

          // ===== FREE FIRE =====
          if (p.mode === 'freefire') {
            const ok = !!(data && data.success);
            if (ok) {
              chip('ok', 'Success');
              markDone('Success');
              // Reuse manualBox for a clean success note (no credentials)
              manualBox.querySelector('.muted').textContent =
                `IGN: ${(data.ign || '-')} • Pack: ${(data.amount || p.uc)}`;
              $('#btnWhatsAppManual').textContent = 'Contact WhatsApp';
              $('#btnWhatsAppManual').addEventListener('click', () => openWhatsApp(p.trxid, label, 'Paid'));
              manualBox.hidden = false; /* keep statusBox visible */ return;
            } else {
              chip('bad', 'Failed');
              markDone('Failed');
              $('#errMsg').textContent = (data && data.message) || 'Top-up failed.';
              $('#btnWhatsAppBad').addEventListener('click', () => openWhatsApp(p.trxid, label, 'Failed'));
              errorBox.hidden = false; /* keep statusBox visible */ return;
            }
          }

          // ===== MANUAL VERIFY ONLY =====
          if (data && data.success) {
            chip('ok', 'Verified');
            markDone('Success');
            $('#btnWhatsAppManual').addEventListener('click', () => openWhatsApp(p.trxid, label, 'Paid'));
            manualBox.hidden = false; /* keep statusBox visible */ return;
          } else {
            chip('bad', 'Failed');
            markDone('Failed');
            $('#errMsg').textContent = (data && data.message) || 'Verification failed.';
            $('#btnWhatsAppBad').addEventListener('click', () => openWhatsApp(p.trxid, label, 'Failed'));
            errorBox.hidden = false; /* keep statusBox visible */ return;
          }
        } catch (e) {
          chip('bad', 'Network');
          markDone('Failed');
          $('#errMsg').textContent = String(e);
          $('#btnWhatsAppBad').addEventListener('click', () => openWhatsApp('', label, 'Pending'));
          errorBox.hidden = false; /* keep statusBox visible */
        }
      }

      run();
    })();
  </script>
</body>

</html>